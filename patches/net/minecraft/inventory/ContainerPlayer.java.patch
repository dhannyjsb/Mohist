--- ../src-base/minecraft/net/minecraft/inventory/ContainerPlayer.java
+++ ../src-work/minecraft/net/minecraft/inventory/ContainerPlayer.java
@@ -1,6 +1,5 @@
 package net.minecraft.inventory;
 
-import javax.annotation.Nullable;
 import net.minecraft.enchantment.EnchantmentHelper;
 import net.minecraft.entity.EntityLiving;
 import net.minecraft.entity.player.EntityPlayer;
@@ -9,188 +8,155 @@
 import net.minecraft.item.ItemStack;
 import net.minecraftforge.fml.relauncher.Side;
 import net.minecraftforge.fml.relauncher.SideOnly;
+import org.bukkit.craftbukkit.v1_12_R1.inventory.CraftInventoryCrafting;
+import org.bukkit.craftbukkit.v1_12_R1.inventory.CraftInventoryView;
 
-public class ContainerPlayer extends Container
-{
-    private static final EntityEquipmentSlot[] VALID_EQUIPMENT_SLOTS = new EntityEquipmentSlot[] {EntityEquipmentSlot.HEAD, EntityEquipmentSlot.CHEST, EntityEquipmentSlot.LEGS, EntityEquipmentSlot.FEET};
-    public InventoryCrafting craftMatrix = new InventoryCrafting(this, 2, 2);
-    public InventoryCraftResult craftResult = new InventoryCraftResult();
-    public boolean isLocalWorld;
+import javax.annotation.Nullable;
+
+public class ContainerPlayer extends Container {
+    private static final EntityEquipmentSlot[] VALID_EQUIPMENT_SLOTS = new EntityEquipmentSlot[]{EntityEquipmentSlot.HEAD, EntityEquipmentSlot.CHEST, EntityEquipmentSlot.LEGS, EntityEquipmentSlot.FEET};
     private final EntityPlayer player;
+    public InventoryCrafting craftMatrix; // CraftBukkit - move initialization into constructor
+    public InventoryCraftResult craftResult; // CraftBukkit - move initialization into constructor
+    public boolean isLocalWorld;
+    private CraftInventoryView bukkitEntity = null;
+    private InventoryPlayer playerInventory;
 
-    public ContainerPlayer(InventoryPlayer playerInventory, boolean localWorld, EntityPlayer playerIn)
-    {
+    public ContainerPlayer(InventoryPlayer playerInventory, boolean localWorld, EntityPlayer playerIn) {
         this.isLocalWorld = localWorld;
         this.player = playerIn;
+        // CraftBukkit start
+        this.craftResult = new InventoryCraftResult(); // CraftBukkit - moved to before InventoryCrafting construction
+        this.craftMatrix = new InventoryCrafting(this, 2, 2, playerInventory.player); // CraftBukkit - pass player
+        this.craftMatrix.resultInventory = this.craftResult; // CraftBukkit - let InventoryCrafting know about its result slot
+        this.playerInventory = playerInventory; // CraftBukkit - save player
+        // CraftBukkit end
         this.addSlotToContainer(new SlotCrafting(playerInventory.player, this.craftMatrix, this.craftResult, 0, 154, 28));
 
-        for (int i = 0; i < 2; ++i)
-        {
-            for (int j = 0; j < 2; ++j)
-            {
+        for (int i = 0; i < 2; ++i) {
+            for (int j = 0; j < 2; ++j) {
                 this.addSlotToContainer(new Slot(this.craftMatrix, j + i * 2, 98 + j * 18, 18 + i * 18));
             }
         }
 
-        for (int k = 0; k < 4; ++k)
-        {
+        for (int k = 0; k < 4; ++k) {
             final EntityEquipmentSlot entityequipmentslot = VALID_EQUIPMENT_SLOTS[k];
-            this.addSlotToContainer(new Slot(playerInventory, 36 + (3 - k), 8, 8 + k * 18)
-            {
-                public int getSlotStackLimit()
-                {
+            this.addSlotToContainer(new Slot(playerInventory, 36 + (3 - k), 8, 8 + k * 18) {
+                public int getSlotStackLimit() {
                     return 1;
                 }
-                public boolean isItemValid(ItemStack stack)
-                {
+
+                public boolean isItemValid(ItemStack stack) {
                     return stack.getItem().isValidArmor(stack, entityequipmentslot, player);
                 }
-                public boolean canTakeStack(EntityPlayer playerIn)
-                {
+
+                public boolean canTakeStack(EntityPlayer playerIn) {
                     ItemStack itemstack = this.getStack();
                     return !itemstack.isEmpty() && !playerIn.isCreative() && EnchantmentHelper.hasBindingCurse(itemstack) ? false : super.canTakeStack(playerIn);
                 }
+
                 @Nullable
                 @SideOnly(Side.CLIENT)
-                public String getSlotTexture()
-                {
+                public String getSlotTexture() {
                     return ItemArmor.EMPTY_SLOT_NAMES[entityequipmentslot.getIndex()];
                 }
             });
         }
 
-        for (int l = 0; l < 3; ++l)
-        {
-            for (int j1 = 0; j1 < 9; ++j1)
-            {
+        for (int l = 0; l < 3; ++l) {
+            for (int j1 = 0; j1 < 9; ++j1) {
                 this.addSlotToContainer(new Slot(playerInventory, j1 + (l + 1) * 9, 8 + j1 * 18, 84 + l * 18));
             }
         }
 
-        for (int i1 = 0; i1 < 9; ++i1)
-        {
+        for (int i1 = 0; i1 < 9; ++i1) {
             this.addSlotToContainer(new Slot(playerInventory, i1, 8 + i1 * 18, 142));
         }
 
-        this.addSlotToContainer(new Slot(playerInventory, 40, 77, 62)
-        {
+        this.addSlotToContainer(new Slot(playerInventory, 40, 77, 62) {
             @Nullable
             @SideOnly(Side.CLIENT)
-            public String getSlotTexture()
-            {
+            public String getSlotTexture() {
                 return "minecraft:items/empty_armor_slot_shield";
             }
         });
     }
 
-    public void onCraftMatrixChanged(IInventory inventoryIn)
-    {
+    public void onCraftMatrixChanged(IInventory inventoryIn) {
         this.slotChangedCraftingGrid(this.player.world, this.player, this.craftMatrix, this.craftResult);
     }
 
-    public void onContainerClosed(EntityPlayer playerIn)
-    {
+    public void onContainerClosed(EntityPlayer playerIn) {
         super.onContainerClosed(playerIn);
         this.craftResult.clear();
 
-        if (!playerIn.world.isRemote)
-        {
+        if (!playerIn.world.isRemote) {
             this.clearContainer(playerIn, playerIn.world, this.craftMatrix);
         }
     }
 
-    public boolean canInteractWith(EntityPlayer playerIn)
-    {
+    public boolean canInteractWith(EntityPlayer playerIn) {
         return true;
     }
 
-    public ItemStack transferStackInSlot(EntityPlayer playerIn, int index)
-    {
+    public ItemStack transferStackInSlot(EntityPlayer playerIn, int index) {
         ItemStack itemstack = ItemStack.EMPTY;
         Slot slot = this.inventorySlots.get(index);
 
-        if (slot != null && slot.getHasStack())
-        {
+        if (slot != null && slot.getHasStack()) {
             ItemStack itemstack1 = slot.getStack();
             itemstack = itemstack1.copy();
             EntityEquipmentSlot entityequipmentslot = EntityLiving.getSlotForItemStack(itemstack);
 
-            if (index == 0)
-            {
-                if (!this.mergeItemStack(itemstack1, 9, 45, true))
-                {
+            if (index == 0) {
+                if (!this.mergeItemStack(itemstack1, 9, 45, true)) {
                     return ItemStack.EMPTY;
                 }
 
                 slot.onSlotChange(itemstack1, itemstack);
-            }
-            else if (index >= 1 && index < 5)
-            {
-                if (!this.mergeItemStack(itemstack1, 9, 45, false))
-                {
+            } else if (index >= 1 && index < 5) {
+                if (!this.mergeItemStack(itemstack1, 9, 45, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (index >= 5 && index < 9)
-            {
-                if (!this.mergeItemStack(itemstack1, 9, 45, false))
-                {
+            } else if (index >= 5 && index < 9) {
+                if (!this.mergeItemStack(itemstack1, 9, 45, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (entityequipmentslot.getSlotType() == EntityEquipmentSlot.Type.ARMOR && !((Slot)this.inventorySlots.get(8 - entityequipmentslot.getIndex())).getHasStack())
-            {
+            } else if (entityequipmentslot.getSlotType() == EntityEquipmentSlot.Type.ARMOR && !((Slot) this.inventorySlots.get(8 - entityequipmentslot.getIndex())).getHasStack()) {
                 int i = 8 - entityequipmentslot.getIndex();
 
-                if (!this.mergeItemStack(itemstack1, i, i + 1, false))
-                {
+                if (!this.mergeItemStack(itemstack1, i, i + 1, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (entityequipmentslot == EntityEquipmentSlot.OFFHAND && !((Slot)this.inventorySlots.get(45)).getHasStack())
-            {
-                if (!this.mergeItemStack(itemstack1, 45, 46, false))
-                {
+            } else if (entityequipmentslot == EntityEquipmentSlot.OFFHAND && !((Slot) this.inventorySlots.get(45)).getHasStack()) {
+                if (!this.mergeItemStack(itemstack1, 45, 46, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (index >= 9 && index < 36)
-            {
-                if (!this.mergeItemStack(itemstack1, 36, 45, false))
-                {
+            } else if (index >= 9 && index < 36) {
+                if (!this.mergeItemStack(itemstack1, 36, 45, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (index >= 36 && index < 45)
-            {
-                if (!this.mergeItemStack(itemstack1, 9, 36, false))
-                {
+            } else if (index >= 36 && index < 45) {
+                if (!this.mergeItemStack(itemstack1, 9, 36, false)) {
                     return ItemStack.EMPTY;
                 }
-            }
-            else if (!this.mergeItemStack(itemstack1, 9, 45, false))
-            {
+            } else if (!this.mergeItemStack(itemstack1, 9, 45, false)) {
                 return ItemStack.EMPTY;
             }
 
-            if (itemstack1.isEmpty())
-            {
+            if (itemstack1.isEmpty()) {
                 slot.putStack(ItemStack.EMPTY);
-            }
-            else
-            {
+            } else {
                 slot.onSlotChanged();
             }
 
-            if (itemstack1.getCount() == itemstack.getCount())
-            {
+            if (itemstack1.getCount() == itemstack.getCount()) {
                 return ItemStack.EMPTY;
             }
 
             ItemStack itemstack2 = slot.onTake(playerIn, itemstack1);
 
-            if (index == 0)
-            {
+            if (index == 0) {
                 playerIn.dropItem(itemstack2, false);
             }
         }
@@ -198,8 +164,18 @@
         return itemstack;
     }
 
-    public boolean canMergeSlot(ItemStack stack, Slot slotIn)
-    {
+    public boolean canMergeSlot(ItemStack stack, Slot slotIn) {
         return slotIn.inventory != this.craftResult && super.canMergeSlot(stack, slotIn);
     }
+
+    @Override
+    public CraftInventoryView getBukkitView() {
+        if (bukkitEntity != null) {
+            return bukkitEntity;
+        }
+
+        CraftInventoryCrafting inventory = new CraftInventoryCrafting(this.craftMatrix, this.craftResult);
+        bukkitEntity = new CraftInventoryView(this.playerInventory.player.getBukkitEntity(), inventory, this);
+        return bukkitEntity;
+    }
 }
